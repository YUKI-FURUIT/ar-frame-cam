<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>超ミニ版・フレーム付きカメラ</title>
<style>
  html,body{margin:0;height:100%;background:#111;color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans JP,sans-serif}
  .wrap{display:flex;flex-direction:column;gap:12px;height:100%;max-width:480px;margin:0 auto;padding:12px}
  .stage{position:relative;flex:1;border-radius:16px;overflow:hidden;background:#000;aspect-ratio:3/4}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  img#frame{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none}
  .ui{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  button,label.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;background:#2d2f39;color:#fff}
  input[type=file]{display:none}
  .hint{opacity:.7;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <video id="cam" playsinline autoplay muted></video>
    <!-- デフォルトの簡易フレーム（データURLのPNG）。あとで好きなPNGに差し替え可 -->
    <img id="frame" alt="frame" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKACAYAAABf2qIhAAAACXBIWXMAAAsSAAALEgHS3X78AAAgAElEQVR4nO3dwY3kOBRG0e9rj6m0c1m2qDqkqgM5Dg9X3w9H2bQ1m4wq+zN3xP6vFJY+8mYB+X6d3I9/8AAgD8v3wGAAAAAABwqg2m0v8m0v9Zz5WbJwAAAPBgG2f8m5r+5l8f8gkAAAB4qNQHAAAAAGBfQwEAAACgFQYAAACgFQYAAACgFQYAAACgFQYAAACgFQYAAACgFQYAAACgFQYAAPg/7f7e7Yv9+fX3fPn5+Q8fP3+8P/8HAgAAoCU9C0Jg+2fFvQ8AAAAASUVORK5CYII=" />
  </div>
  <div class="ui">
    <button id="start">カメラ開始</button>
    <button id="flip">カメラ切替</button>
    <label class="btn" for="file">フレーム差し替え</label>
    <input id="file" type="file" accept="image/png,image/*">
  </div>
  <p class="hint">HTTPSで開き、カメラ権限を許可してください。保存機能なし。フレームは端末内で一時利用のみ。</p>
</div>
<script>
  const video = document.getElementById('cam');
  const frame = document.getElementById('frame');
  const file = document.getElementById('file');
  let stream; let usingBack = true;

  async function startCamera(){
    try{
      if(stream) stream.getTracks().forEach(t=>t.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        audio:false,
        video:{ facingMode: usingBack ? {exact:'environment'} : 'user', width:{ideal:1920}, height:{ideal:1080} }
      });
      video.srcObject = stream;
    }catch(e){
      try{ // フォールバック
        stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        video.srcObject = stream;
      }catch(err){
        alert('カメラ開始に失敗。HTTPSと権限を確認してください\n'+(err?.message||''));
      }
    }
  }

  document.getElementById('start').onclick = startCamera;
  document.getElementById('flip').onclick = async ()=>{ usingBack=!usingBack; await startCamera(); };

  file.onchange = (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    frame.onload = ()=> URL.revokeObjectURL(url);
    frame.src = url; // 端末内の一時URLを直接表示（アップロードなし）
  };
</script>
</body>
</html>
